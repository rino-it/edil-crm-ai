Contesto
Il modulo finanziario attuale ha problemi strutturali:

Nessuna paginazione in tutto il codebase (ogni query carica TUTTI i dati)
Scadenziario caotico: pagato e da pagare mischiati, nessun tab "Da Smistare"
Riconciliazione senza dashboard: niente card conti, niente archivio mensile
Fatture di vendita non importate: solo fatture acquisto via Python script
Cantiere singolo per fattura: impossibile dividere una fattura su piu cantieri
Niente programmazione cashflow: il DSO e solo un numero, non uno strumento gestionale

Obiettivo: sistema chiaro, ordinato, ottimizzato, eseguibile.

FASE 0: Infrastruttura Base (Prerequisito per tutto)
0.1 — Tipi condivisi paginazione
CREA: types/pagination.ts
typescriptexport interface PaginationParams { page: number; pageSize: number }
export interface PaginatedResult<T> {
  data: T[]; totalCount: number; page: number;
  pageSize: number; totalPages: number;
}
export const PAGE_SIZE_OPTIONS = [5, 25, 50] as const;
export const DEFAULT_PAGE_SIZE = 25;
0.2 — Componente UI paginazione
CREA: components/ui/pagination-controls.tsx (client component)

Selettore righe per pagina (5/25/50)
Bottoni Prev/Next + "Pagina X di Y"
Aggiorna URL params (?page=2&pageSize=25) via useRouter().push()
Server component ri-fetcha automaticamente al cambio URL

0.3 — Helper paginato in data-fetcher.ts
MODIFICA: utils/data-fetcher.ts (aggiungi in cima)
typescriptasync function paginatedQuery<T>(queryBuilder, params: PaginationParams): PaginatedResult<T> {
  const from = (params.page - 1) * params.pageSize;
  const to = from + params.pageSize - 1;
  const { data, count } = await queryBuilder.range(from, to);
  return { data, totalCount: count, page: params.page, pageSize: params.pageSize,
           totalPages: Math.ceil(count / params.pageSize) };
}
CRITICO: ogni query paginata DEVE usare .select('*', { count: 'exact' }) per ottenere il count senza caricare tutto.
0.4 — Tipi finanziari condivisi
CREA: types/finanza.ts — Types per ScadenzaWithSoggetto, ContoSummary, ScadenzaCantiereAllocation
File toccati Fase 0: 4 (2 creati, 2 modificati)

FASE 1: Migrazioni Database
Tutte le modifiche schema PRIMA di scrivere codice applicativo.
1.1 — Tabella multi-cantiere
sqlCREATE TABLE scadenze_cantiere (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  scadenza_id UUID NOT NULL REFERENCES scadenze_pagamento(id) ON DELETE CASCADE,
  cantiere_id UUID NOT NULL REFERENCES cantieri(id) ON DELETE RESTRICT,
  importo NUMERIC(12,2) NOT NULL CHECK (importo > 0),
  note TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(scadenza_id, cantiere_id)
);
CREATE INDEX idx_scadenze_cantiere_scadenza ON scadenze_cantiere(scadenza_id);
CREATE INDEX idx_scadenze_cantiere_cantiere ON scadenze_cantiere(cantiere_id);
Logica: se fattura ha UN cantiere → scadenze_pagamento.cantiere_id impostato, tabella vuota. Se MULTI-cantiere → cantiere_id = NULL, righe in scadenze_cantiere con importi parziali.
1.2 — Tabelle fatture di vendita
sqlCREATE TABLE fatture_vendita (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  ragione_sociale TEXT NOT NULL, piva_cliente TEXT,
  numero_fattura TEXT NOT NULL, data_fattura DATE NOT NULL,
  importo_totale NUMERIC(12,2) NOT NULL, importo_iva NUMERIC(12,2) DEFAULT 0,
  nome_file_xml TEXT, url_storage TEXT,
  cantiere_id UUID REFERENCES cantieri(id),
  scadenza_id UUID REFERENCES scadenze_pagamento(id),
  soggetto_id UUID REFERENCES anagrafica_soggetti(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE fatture_vendita_righe (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  fattura_id UUID NOT NULL REFERENCES fatture_vendita(id) ON DELETE CASCADE,
  descrizione TEXT, quantita NUMERIC(10,3), prezzo_unitario NUMERIC(12,4),
  importo NUMERIC(12,2), ddt_riferimento TEXT, codice_articolo TEXT
);
1.3 — Colonne categoria su scadenze
sqlALTER TABLE scadenze_pagamento ADD COLUMN IF NOT EXISTS categoria TEXT DEFAULT NULL;
-- Valori: null (normale), 'ufficio', 'multa', 'sanzione', 'burocrazia', 'utenza'
ALTER TABLE scadenze_pagamento ADD COLUMN IF NOT EXISTS fattura_vendita_id UUID REFERENCES fatture_vendita(id);
1.4 — Colonne archivio upload
sqlALTER TABLE upload_banca ADD COLUMN IF NOT EXISTS anno INTEGER;
ALTER TABLE upload_banca ADD COLUMN IF NOT EXISTS mese INTEGER;
ALTER TABLE upload_banca ADD COLUMN IF NOT EXISTS archiviato BOOLEAN DEFAULT FALSE;
CREATE INDEX idx_upload_banca_periodo ON upload_banca(conto_banca_id, anno, mese);
1.5 — View "Da Smistare" + Funzione KPI
sqlCREATE VIEW v_scadenze_da_smistare AS
SELECT sp.* FROM scadenze_pagamento sp
LEFT JOIN scadenze_cantiere sc ON sc.scadenza_id = sp.id
WHERE sp.cantiere_id IS NULL AND sc.id IS NULL AND sp.stato != 'pagato';

CREATE OR REPLACE FUNCTION get_scadenze_kpis() RETURNS JSON AS $$
  SELECT json_build_object(
    'daIncassare', COALESCE(SUM(CASE WHEN tipo='entrata' AND stato IN ('da_pagare','parziale')
                   THEN importo_totale - importo_pagato END), 0),
    'daPagare', COALESCE(SUM(CASE WHEN tipo='uscita' AND stato IN ('da_pagare','parziale')
                THEN importo_totale - importo_pagato END), 0),
    'scaduto', COALESCE(SUM(CASE WHEN stato='scaduto'
               THEN importo_totale - importo_pagato END), 0),
    'daSmistare', (SELECT COUNT(*) FROM v_scadenze_da_smistare),
    'dso', COALESCE((SELECT ROUND(AVG(EXTRACT(DAY FROM data_pagamento::timestamp - data_emissione::timestamp)))
           FROM scadenze_pagamento WHERE tipo='entrata' AND stato='pagato'
           AND data_pagamento > CURRENT_DATE - INTERVAL '90 days'), 0)
  ) FROM scadenze_pagamento WHERE stato != 'pagato';
$$ LANGUAGE sql STABLE;
1.6 — Partizionamento trimestrale movimenti_banca
ESEGUIRE PER ULTIMO (durante manutenzione):
sqlALTER TABLE movimenti_banca RENAME TO movimenti_banca_old;
CREATE TABLE movimenti_banca (...same columns...)
  PARTITION BY RANGE (data_operazione);
-- Creare partizioni: 2024_q1 ... 2026_q2
INSERT INTO movimenti_banca SELECT * FROM movimenti_banca_old;
```
**Perche partizionamento invece di tabelle separate**: il codice applicativo NON cambia. Queries su `movimenti_banca` funzionano identiche. PostgreSQL filtra automaticamente per partizione quando c'e `WHERE data_operazione`. Zero modifiche al codice.

**Ordine esecuzione migrazioni**: 1.1 → 1.2 → 1.3 → 1.4 → 1.5 → 1.6 (ultimo)

---

## FASE 2: Ristrutturazione Scadenziario

### Nuova struttura pagine
```
app/scadenze/
  layout.tsx              -- Barra KPI + navigazione tab
  page.tsx                -- Redirect a /scadenze/da-pagare
  da-pagare/page.tsx      -- Uscite non pagate
  da-incassare/page.tsx   -- Entrate non incassate
  scadute/page.tsx        -- Tutti gli scaduti
  da-smistare/page.tsx    -- cantiere_id IS NULL (da v_scadenze_da_smistare)
  pagate/page.tsx         -- Archivio pagamenti completati
  actions.ts              -- Esistente + nuove azioni
  components/
    ScadenzeTable.tsx           -- Tabella paginata condivisa
    ScadenzeKPIBar.tsx          -- Barra KPI cards
    AssegnaCantiereModal.tsx    -- Modal multi-cantiere (NUOVO)
    RegistraPagamentoModal.tsx  -- Modal pagamento (refactored da inline)
    ScadenzaRowActions.tsx      -- Azioni per riga
2.1 — Layout con tab + KPI
CREA: app/scadenze/layout.tsx

Server component: chiama get_scadenze_kpis() una volta
Renderizza: 4 KPI cards (Da Incassare, Da Pagare, Scaduto, Da Smistare con count badge)
Tab navigation: Da Pagare | Da Incassare | Scadute | Da Smistare (47) | Pagate
Contenuto delle sotto-pagine via {children}

2.2 — Tabella paginata condivisa
CREA: app/scadenze/components/ScadenzeTable.tsx (client component)

Accetta: data[], paginationResult, showCantiereColumn, showPagamentoActions
Desktop: Table shadcn con colonne Soggetto, Fattura, Importo, Residuo, Scadenza, Cantiere, Azioni
Mobile: Card layout (riusa pattern esistente)
Footer: <PaginationControls />
Azioni per riga: Paga, Assegna Cantiere, WhatsApp, Calendario

2.3 — Funzioni data-fetcher paginate
MODIFICA: utils/data-fetcher.ts
typescriptexport async function getScadenzePaginated(filtri, pagination): PaginatedResult<ScadenzaWithSoggetto>
// Query: scadenze_pagamento + join soggetto + cantiere + scadenze_cantiere
// Filtri: tipo, stato[], cantiere_id, categoria, search text
// Paginazione server-side via .range()

export async function getScadenzeKPIs() // Chiama RPC get_scadenze_kpis
2.4 — Modal multi-cantiere
CREA: app/scadenze/components/AssegnaCantiereModal.tsx

Toggle: "Cantiere singolo" vs "Dividi tra cantieri"
Modo singolo: dropdown cantiere → salva su scadenze_pagamento.cantiere_id
Modo multi: righe dinamiche [Cantiere dropdown + Importo input] + "Aggiungi cantiere"
Validazione: somma importi DEVE essere = importo_totale
Se DDT presente: pre-compila suggerimento cantiere da fatture_dettaglio_righe.ddt_riferimento
Salva in scadenze_cantiere + imposta cantiere_id = NULL

2.5 — Nuove server actions
MODIFICA: app/scadenze/actions.ts (aggiungi):
typescriptexport async function assegnaMultiCantiere(scadenzaId, allocazioni[])
// Valida somma, delete vecchie righe, insert nuove in scadenze_cantiere

export async function inviaReminderWhatsApp(scadenzaId)
// Fetch scadenza+soggetto, compose msg, sendWhatsAppMessage, append calendar link

export async function assegnaCantiereBulk(scadenzaIds[], cantiereId)
// Aggiornamento massivo per "Da Smistare"
2.6 — Pagine tab individuali
Ogni pagina segue lo STESSO pattern:
typescript// Server component
// 1. Legge searchParams (page, pageSize, search)
// 2. Chiama getScadenzePaginated({ tipo: X, stato: [Y] }, pagination)
// 3. Renderizza <ScadenzeTable data={result.data} pagination={result} />
```

| Pagina | Filtro | Note |
|--------|--------|------|
| `da-pagare` | tipo=uscita, stato=[da_pagare, parziale] | Vista principale |
| `da-incassare` | tipo=entrata, stato=[da_pagare, parziale] | Crediti aperti |
| `scadute` | stato=scaduto | Con aging breakdown |
| `da-smistare` | Query su `v_scadenze_da_smistare` | Azioni assegna prominenti, bulk select |
| `pagate` | stato=pagato | Archivio, sort per data_pagamento DESC |

**File toccati Fase 2**: ~12 (6 pagine create, 3 componenti, 2 modificati, 1 layout)

---

## FASE 3: Pagine Finanziarie Dedicate

### Nuova struttura
```
app/finanza/
  page.tsx                       -- Dashboard esistente (MODIFICA: link alle sotto-pagine)
  da-incassare/page.tsx          -- Gestione crediti dedicata
  da-pagare/page.tsx             -- Gestione debiti dedicata
  scaduto/page.tsx               -- Gestione scaduti + escalation
  programmazione/page.tsx        -- Cashflow planning (SOSTITUISCE DSO)
  importa-fatture/page.tsx       -- Import fatture vendita/acquisto
  components/
    WhatsAppReminderButton.tsx   -- Bottone invio sollecito
    CalendarLinkButton.tsx       -- Bottone link calendario
```

### 3.1 — Pagina Da Incassare
**CREA**: `app/finanza/da-incassare/page.tsx`
```
Layout:
[KPI: Totale Crediti | Scaduti | In Scadenza 7gg | DSO]
[Aging Chart: 0-30 | 31-60 | 61-90 | 90+]
[Filtri: Search + Cantiere + Periodo + Ordina per]
[Tabella paginata con azioni: WhatsApp + Calendario + Paga]
[PaginationControls]
```
Per ogni riga: bottone "Invia Sollecito" → `inviaReminderWhatsApp()` → msg al cliente con link calendario Apple.

### 3.2 — Pagina Da Pagare
Stessa struttura ma per `tipo=uscita`. WhatsApp qui e un PROMEMORIA all'admin: "Ricorda di pagare fattura X a fornitore Y entro data Z"

### 3.3 — Pagina Scaduto
Split in 2 sezioni: "Crediti Scaduti" + "Debiti Scaduti" con aging. Colore per giorni ritardo: giallo (1-30), arancione (31-60), rosso (60+). Solleciti WhatsApp con messaggi escalanti.

### 3.4 — Pagina Programmazione (PRIORITA ALTA)
**CREA**: `app/finanza/programmazione/page.tsx`
```
Layout:
[Grafico Cashflow Interattivo 90gg]
  - Barre verdi = entrate previste per settimana
  - Barre rosse = uscite previste per settimana
  - Linea = saldo proiettato
  - Linea soglia alert
[Tabella proiezione settimanale]
  Settimana | Entrate | Uscite | Saldo Prev.
[Zona Alert: "Saldo negativo previsto settimana X"]
  [Invia Alert WhatsApp]
Funzione data-fetcher:
typescriptexport async function getCashflowProjection(days = 90) {
  // 1. Saldo attuale da SUM(conti_banca.saldo_attuale)
  // 2. Tutte scadenze non-pagate entro {days} giorni
  // 3. Raggruppa per settimana ISO
  // 4. Calcola saldo progressivo
  // 5. Segnala settimane con saldo negativo
}
3.5 — Aggiorna Dashboard Finanza
MODIFICA: app/finanza/page.tsx

KPI card DSO → diventa "Programmazione" con link a /finanza/programmazione
"Da Incassare" cliccabile → /finanza/da-incassare
"Da Pagare" cliccabile → /finanza/da-pagare
Aging chart cliccabile → /finanza/scaduto

3.6 — Estendi route calendario
MODIFICA: app/api/calendar/route.ts

Supporta ?scadenzaId=xxx per evento singolo
VALARM a -3 giorni e -1 giorno

File toccati Fase 3: ~10 (5 pagine create, 2 componenti, 3 modificati)

FASE 4: Importazione Fatture di Vendita
4.1 — Script Python parser fatture vendita
CREA: scripts/fatture_vendita_xml.py
Segue ESATTAMENTE il pattern di riconciliazione_xml.py:

Parse XML FatturaElettronica (noi siamo CedentePrestatore, cliente e CessionarioCommittente)
Estrae: ragione_sociale cliente, P.IVA, numero_fattura, data, importo
Upsert anagrafica_soggetti (tipo='cliente')
Insert fatture_vendita + fatture_vendita_righe
Auto-genera scadenze_pagamento (tipo='entrata')
Cerca cantiere da DDT reference nelle righe

4.2 — Route API import (alternativa web)
CREA: app/api/import/fatture-vendita/route.ts
POST con upload XML, stessa logica del Python ma eseguibile da UI.
4.3 — Categorizzazione costi fissi
CREA: utils/categorizza-scadenza.ts
typescriptconst KEYWORDS = {
  'ufficio': ['affitto', 'canone', 'ufficio', 'cancelleria'],
  'utenza': ['enel', 'eni', 'gas', 'luce', 'acqua', 'telefono', 'tim'],
  'multa': ['multa', 'contravvenzione', 'sanzione stradale'],
  'sanzione': ['sanzione', 'penale', 'ammenda'],
  'burocrazia': ['pratica', 'bollo', 'visura', 'camerale', 'CCIAA', 'INPS', 'INAIL', 'F24'],
};
export function categorizzaScadenza(descrizione, ragioneSociale): string | null
```
Se `categoria != null` e nessun cantiere → assegna a cantiere virtuale "Ufficio".

### 4.4 — UI importazione
**CREA**: `app/finanza/importa-fatture/page.tsx`
```
[Tab: Fatture Acquisto | Fatture Vendita]
[Upload zone: drag & drop XML]
[Tabella preview prima di conferma: N.Fattura, Soggetto, Importo, Cantiere(auto), Categoria(auto)]
[Bottone "Conferma Importazione"]
[Storico importazioni paginato]
4.5 — DDT-to-Cantiere matcher
CREA: utils/ddt-matcher.ts
typescriptexport async function matchDDTtoCantiere(ddtReferences: string[])
// 1. Estrai codice cantiere da pattern DDT
// 2. Query cantieri.codice
// 3. Return { cantiere_id, confidence, reason }
```

**File toccati Fase 4**: ~6 (4 creati, 2 modificati)

---

## FASE 5: Ristrutturazione Riconciliazione

### Nuova struttura
```
app/finanza/riconciliazione/
  page.tsx                          -- DASHBOARD (trasformata)
  [contoId]/page.tsx                -- Vista per-conto
  ClientRiconciliazione.tsx         -- Esistente (accetta contoId prop)
  actions.ts                        -- Esistente + upload con anno/mese
  components/
    ContoCard.tsx                   -- Card conto bancario
    UploadCalendar.tsx              -- Griglia 12 mesi upload
    AggiungiContoDialog.tsx         -- Dialog nuovo conto
```

### 5.1 — Dashboard riconciliazione
**MODIFICA**: `app/finanza/riconciliazione/page.tsx`
```
Layout:
[KPI: Movimenti Totali | Da Riconciliare | Riconciliati % | Saldo Totale]
[CARD GRID conti banca]:
  +------------------+  +------------------+
  | BNL Conto Princ. |  | Unicredit Op.    |
  | IBAN: IT...1234   |  | IBAN: IT...5678  |
  | Saldo: EUR 45,230 |  | Saldo: EUR 12,100|
  | Da riconc: 23     |  | Da riconc: 8     |
  | [Apri] [Upload]   |  | [Apri] [Upload]  |
  +------------------+  +------------------+
  [+ Aggiungi Conto]
[ARCHIVIO UPLOAD]:
  Conto: [BNL ▼]  Anno: [2026 ▼]
  Gen | Feb | Mar | Apr | Mag | ...
   ✓  |  ✓  |  -  |  -  |  -  |
5.2 — Vista per-conto
CREA: app/finanza/riconciliazione/[contoId]/page.tsx

URL: /finanza/riconciliazione/{contoId}?page=1&pageSize=25&mese=2&anno=2026
Riusa ClientRiconciliazione.tsx con prop contoId per filtrare movimenti
Upload scoped al conto specifico
Movimenti paginati (server-side)

5.3 — Upload mensile
MODIFICA: app/finanza/riconciliazione/actions.ts
typescriptexport async function uploadBankStatement(contoId, file, anno, mese)
// 1. Upload file su Supabase Storage
// 2. Insert upload_banca con anno, mese
// 3. Parse e insert movimenti_banca
5.4 — Calendario upload
CREA: app/finanza/riconciliazione/components/UploadCalendar.tsx
Griglia 12 mesi: verde = upload presente, giallo = mese corrente senza upload, vuoto = futuro.
5.5 — Promemoria WhatsApp upload mensile
MODIFICA: app/api/cron/scadenze/route.ts (aggiungi):
typescript// Il 5 di ogni mese, per ogni conto_banca attivo:
// Se manca upload per (mese corrente, anno corrente):
//   sendWhatsAppMessage(admin, "Ricorda di caricare estratto conto {banca} per {mese}/{anno}")
//   Allega link calendario Apple
5.6 — Funzioni data-fetcher
MODIFICA: utils/data-fetcher.ts
typescriptexport async function getContiSummary(): ContoSummary[]
// Per ogni conto: join movimenti per count non_riconciliati, ultimo upload

export async function getUploadArchive(contoId, anno)
// Query upload_banca raggruppati per mese

export async function getMovimentiPaginati(contoId, pagination, filtri)
// Movimenti paginati per conto specifico
```

**File toccati Fase 5**: ~8 (4 creati, 4 modificati)

---

## FASE 6: Navigazione + Paginazione Retrofit

### 6.1 — Aggiorna Sidebar
**MODIFICA**: `components/Sidebar.tsx`
```
Cantieri
Personale
Anagrafiche
Scadenze (con sotto-menu espandibile)
  ├ Da Pagare
  ├ Da Incassare
  ├ Scadute
  ├ Da Smistare (badge count)
  └ Pagate
Finanza (con sotto-menu)
  ├ Dashboard
  ├ Programmazione
  └ Importa Fatture
Riconciliazione
```

### 6.2 — Paginazione retrofit pagine esistenti
- `app/anagrafiche/page.tsx` → aggiungi paginazione lista soggetti
- `app/anagrafiche/[id]/page.tsx` → pagina fatture aperte + storico pagamenti

---

## RIEPILOGO FILE

### File da CREARE (26):
```
types/pagination.ts
types/finanza.ts
components/ui/pagination-controls.tsx
app/scadenze/layout.tsx
app/scadenze/da-pagare/page.tsx
app/scadenze/da-incassare/page.tsx
app/scadenze/scadute/page.tsx
app/scadenze/da-smistare/page.tsx
app/scadenze/pagate/page.tsx
app/scadenze/components/ScadenzeTable.tsx
app/scadenze/components/ScadenzeKPIBar.tsx
app/scadenze/components/AssegnaCantiereModal.tsx
app/scadenze/components/RegistraPagamentoModal.tsx
app/scadenze/components/ScadenzaRowActions.tsx
app/finanza/da-incassare/page.tsx
app/finanza/da-pagare/page.tsx
app/finanza/scaduto/page.tsx
app/finanza/programmazione/page.tsx
app/finanza/importa-fatture/page.tsx
app/finanza/components/WhatsAppReminderButton.tsx
app/finanza/components/CalendarLinkButton.tsx
app/finanza/riconciliazione/[contoId]/page.tsx
app/finanza/riconciliazione/components/UploadCalendar.tsx
app/finanza/riconciliazione/components/AggiungiContoDialog.tsx
app/finanza/riconciliazione/components/ContoCard.tsx
utils/categorizza-scadenza.ts
utils/ddt-matcher.ts
scripts/fatture_vendita_xml.py
app/api/import/fatture-vendita/route.ts
```

### File da MODIFICARE (11):
```
utils/data-fetcher.ts              -- +200 righe: query paginate, KPIs, cashflow
app/scadenze/page.tsx              -- Redirect a /scadenze/da-pagare
app/scadenze/actions.ts            -- +multi-cantiere, WhatsApp, bulk assign
app/finanza/page.tsx               -- Link sotto-pagine, DSO → Programmazione
app/finanza/riconciliazione/page.tsx            -- Trasforma in dashboard
app/finanza/riconciliazione/ClientRiconciliazione.tsx -- Accetta contoId prop
app/finanza/riconciliazione/actions.ts          -- Upload con anno/mese
app/api/calendar/route.ts          -- Supporta scadenzaId
app/api/cron/scadenze/route.ts     -- Promemoria upload mensile
components/Sidebar.tsx             -- Ristruttura navigazione
app/anagrafiche/page.tsx + [id]/page.tsx -- Paginazione
```

### Migrazioni Database (6):
```
001_create_scadenze_cantiere.sql
002_create_fatture_vendita.sql
003_alter_scadenze_add_categoria.sql
004_alter_upload_banca_archival.sql
005_create_views_functions.sql
006_partition_movimenti_banca.sql   (ULTIMO, in manutenzione)
```

---

## ORDINE ESECUZIONE
```
Settimana 1: Fase 0 (infrastruttura) + Fase 1 (migrazioni 1-5)
Settimana 2: Fase 2 (scadenziario completo)
Settimana 3: Fase 3 (pagine finanziarie + programmazione)
Settimana 4: Fase 4 (import fatture vendita)
Settimana 5: Fase 5 (riconciliazione dashboard) + Migrazione 1.6 (partizionamento)
Settimana 6: Fase 6 (navigazione + retrofit) + Test

VERIFICA

Paginazione: ogni tabella mostra max 25 righe default, cambio pagina non ricarica tutta la pagina
Da Smistare: tab mostra TUTTE le fatture con cantiere_id IS NULL e senza righe in scadenze_cantiere
Multi-cantiere: modal permette di dividere importo tra 2+ cantieri, somma validata = totale fattura
Programmazione: grafico cashflow 90gg con saldo settimanale, alert su settimane negative
Fatture vendita: import XML crea scadenze tipo=entrata con associazione cantiere automatica
Riconciliazione: dashboard mostra card per ogni conto, click apre vista filtrata per-conto
WhatsApp: solleciti scadenze + promemoria upload mensili funzionanti
Partitioning: SELECT * FROM movimenti_banca WHERE data_operazione > '2026-01-01' interroga solo partizione corrente

All TypeScript errors have been fixed. `npx tsc --noEmit` passes with **zero errors**. Here's what was done:

### Files Modified

1. **[`components/ui/pagination-controls.tsx`](components/ui/pagination-controls.tsx:8)** — Added optional `paramName` and `searchParams` props to [`PaginationControlsProps`](components/ui/pagination-controls.tsx:8). Updated [`createPageURL()`](components/ui/pagination-controls.tsx:22) to use custom param names and pass extra search params through.

2. **[`utils/data-fetcher.ts`](utils/data-fetcher.ts:872)** — Extended [`getKPIAnagrafiche()`](utils/data-fetcher.ts:872) return type to include `totale_debiti` and `totale_crediti` (computed from open scadenze). Added `tipo` filter parameter to [`getAnagrafichePaginate()`](utils/data-fetcher.ts:2287). Added [`SoggettoAnagrafica`](utils/data-fetcher.ts:2287) interface and typed the generic `executePaginatedQuery<SoggettoAnagrafica>` call to resolve the `'s' is of type 'unknown'` error.

3. **[`app/api/calendar/route.ts`](app/api/calendar/route.ts:34)** — Fixed Supabase FK join property access. Supabase can return arrays for relations; added `Array.isArray()` guards before accessing `.ragione_sociale`, `.codice`, and `.titolo`.

4. **[`app/finanza/programmazione/page.tsx`](app/finanza/programmazione/page.tsx:79)** — Fixed Recharts `Tooltip` `formatter` type. Changed `(value: number)` to `(value)` with `Number(value ?? 0)` to handle `number | undefined`.

5. **[`app/scadenze/components/AssegnaCantiereModal.tsx`](app/scadenze/components/AssegnaCantiereModal.tsx:82)** — Fixed mode literal type narrowing by adding `as const` to both `'singolo'` and `'multiplo'` string literals in the ternary.

6. **[`app/layout.tsx`](app/layout.tsx:4)** — Fixed `Sidebar` import from default to named: `import { Sidebar }`.

### Files Created

7. **[`components/ui/dialog.tsx`](components/ui/dialog.tsx)** — Created the missing Dialog component (using `@radix-ui/react-dialog` which was already installed) with all exports: `Dialog`, `DialogTrigger`, `DialogContent`, `DialogHeader`, `DialogFooter`, `DialogTitle`, `DialogDescription`, `DialogClose`, `DialogOverlay`, `DialogPortal`.

No changes were made to the plan at [`plans/08.md`](plans/08.md).